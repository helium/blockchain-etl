%% -*- erlang -*-
{erl_opts,
 [
  debug_info,
  {parse_transform, lager_transform}
  %% warnings_as_errors
 ]}.

{shell,
 [
  {apps, [lager]}
 ]}.


{deps,
 [
  lager,
  recon,
  jsone,
  {hackney, "1.15.2"},
  {base64url, "1.0.1"},
  {epgsql, "4.3.0"},
  {poolboy, "1.5.2"},
  {observer_cli, "1.5.0"},
  {telemetry, "0.4.1"},
  {psql_migration, {git, "https://github.com/helium/psql-migration.git", {branch, "master"}}},
  {clique, {git, "https://github.com/helium/clique.git", {branch, "develop"}}},
  {blockchain,
   {git, "https://github.com/helium/blockchain-core.git",
    {branch, "macpie/ch5377/data-credits-state-channels"}}},
  {envloader, {git, "https://github.com/nuex/envloader.git", {branch, "master"}}}
 ]}.

{xref_checks,
 [
  undefined_function_calls,
  undefined_functions
 ]}.

{shell, [{apps, [lager, envloader, epgsql]}]}.

{profiles,
 [
  {prod,
   [
    {relx, [
            {release, {blockchain_etl, "0.1.0"}, [ blockchain_etl ]},
            {dev_mode, false},
            {include_erts, true},
            {sys_config, "./config/prod.config"},
            {overlay,
             [
              {copy, "config/sys.config", "config/sys.config"},
              {copy, "migrations/*.sql", "migrations/"},
              {copy, "./_build/default/bin/psql_migration", "bin/psql_migration"},
              {copy, "priv/genesis", "update/genesis"},
              {copy, "scripts/extensions/genesis", "bin/extensions/genesis"},
              {copy, "scripts/extensions/info", "bin/extensions/info"},
              {copy, "./_build/prod/lib/blockchain/scripts/extensions/peer", "bin/extensions/peer"},
              {copy, "./_build/prod/lib/blockchain/scripts/extensions/ledger", "bin/extensions/ledger"},
              {copy, "./_build/prod/lib/blockchain/scripts/extensions/trace", "bin/extensions/trace"},
              {copy, "./_build/prod/lib/blockchain/scripts/extensions/txn", "bin/extensions/txn"},
              {template, "config/vm.args", "{{output_dir}}/releases/{{release_version}}/vm.args"}
             ]},
            {extended_start_script, true},
            {include_src, false},
            {extended_start_script_hooks,
             [
              {post_start,
               [
                {wait_for_process, blockchain_worker}
               ]}
             ]},
            {extended_start_script_extensions,
             [
              {genesis, "extensions/genesis"},
              {info, "extensions/info"},
              {peer, "extensions/peer"},
              {ledger, "extensions/ledger"},
              {trace, "extensions/trace"},
              {txn, "extensions/txn"}
             ]}

           ]}
   ]},
  {dev,
   [
    {relx, [
            {release, {blockchain_etl, "0.1.0"}, [ blockchain_etl ]},
            {dev_mode, true},
            {include_erts, false},
            {sys_config, "./config/dev.config"},
            {overlay,
             [
              {copy, "config/sys.config", "config/sys.config"},
              {copy, "migrations/*.sql", "migrations/"},
              {copy, "./_build/default/bin/psql_migration", "bin/psql_migration"},
              {copy, "priv/genesis", "update/genesis"},
              {copy, "scripts/extensions/genesis", "bin/extensions/genesis"},
              {copy, "scripts/extensions/info", "bin/extensions/info"},
              {copy, "./_build/dev/lib/blockchain/scripts/extensions/peer", "bin/extensions/peer"},
              {copy, "./_build/dev/lib/blockchain/scripts/extensions/ledger", "bin/extensions/ledger"},
              {copy, "./_build/dev/lib/blockchain/scripts/extensions/trace", "bin/extensions/trace"},
              {copy, "./_build/dev/lib/blockchain/scripts/extensions/txn", "bin/extensions/txn"},
              {template, "config/vm.args", "{{output_dir}}/releases/{{release_version}}/vm.args"}
             ]},
            {extended_start_script, true},
            {include_src, true},
            {extended_start_script_hooks,
             [
              {post_start,
               [
                {wait_for_process, blockchain_worker}
               ]}
             ]},
            {extended_start_script_extensions,
             [
              {genesis, "extensions/genesis"},
              {info, "extensions/info"},
              {peer, "extensions/peer"},
              {ledger, "extensions/ledger"},
              {trace, "extensions/trace"},
              {txn, "extensions/txn"}
             ]}
           ]}
   ]}
 ]}.
